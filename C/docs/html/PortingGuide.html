<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AWSIoTEmbeddedCDeviceSDK: Porting Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.2 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Porting Guide </h1>  </div>
</div>
<div class="contents">
<h2><a class="anchor" id="scopePG"></a>
Scope</h2>
<p>The scope of this document is to provide instructions to modify the provided source files and functions in of this SDK to run in a variety of embedded Câ€“based environments (e.g. real-time OS, embedded Linux) and to be adjusted to use a specific TLS implementation as available with specific hardware platforms.</p>
<h2><a class="anchor" id="ContentsPortingGuide"></a>
Content of This SDK</h2>
<p>The SDK ported for linux can be downloaded from the below links. <a href="https://s3.amazonaws.com/aws-iot-device-sdk-embedded-c/linux_mqtt_mbedtls-1.0.1.tar">mbedTLS from ARM</a> mbedTLS<br/>
 <a href="https://s3.amazonaws.com/aws-iot-device-sdk-embedded-c/linux_mqtt_openssl-1.0.1.tar">OpenSSL </a> OpenSSL <br/>
</p>
<p>The C-code files of this SDK are delivered via the following directory structure (see comment behind folder name for an explanation of its content). Directory structure Current SDK Directory Layout (OpenSSL)</p>
<p>|--aws_iot_src (Source files of the AWS IoT device SDK) <br/>
 |--aws_mqtt_embedded_client_lib (MQTT library based on <a href="http://www.eclipse.org/paho/clients/c/embedded/">Eclipse Paho</a> Embedded C client) <br/>
 |--certs (Private key, device certificate and Root CA) <br/>
 |--docs (Developer guide &amp; API documentation) <br/>
 |--sample_apps (makefiles to build sample on openSSL) <br/>
</p>
<p>Current SDK Directory Layout (mbedTLS)</p>
<p>|--aws_iot_src (Source files of the AWS IoT device SDK) <br/>
 |--aws_mqtt_embedded_client_lib (MQTT library based on <a href="http://www.eclipse.org/paho/clients/c/embedded/">Eclipse Paho</a> Embedded C client) <br/>
 |--certs (Private key, device certificate and Root CA) <br/>
 |--docs (Developer guide &amp; API documentation) <br/>
 |--mbedtls_lib (mbedTLS implementation library) <br/>
 |--sample_apps (makefiles to build sample on mbedTLS) <br/>
</p>
<p>All makefiles in this SDK were configured using the documented folder structure above, so moving or renaming folders will require modifications to makefiles. </p>
<h2><a class="anchor" id="folderExplanation"></a>
Explanation of folders and their content:</h2>
<p>iot_src: This directory contains the SDK source code including wrappers around the MQTT library, device shadow code and utilities.</p>
<p>aws_mqtt_embedded_client_lib: The source code for the Embedded C MQTT client. This client is a modified version of the Eclipse Paho Embedded C MQTT client. The modifications include improved keep alive handling (callback on disconnect), a fix for unsubscribe functionality, buffer protection against too large MQTT messages and additional callback context to allow for a better layered architecture of the AWS IoT SDK.</p>
<p>certs: This directory is initially empty and will need to contain the private key, the client certificate and the root CA. The client certificate and private key can be downloaded from the AWS IoT console or be created using the AWS CLI commands. The root CA can be downloaded from <a href="https://www.symantec.com/content/en/us/enterprise/verisign/roots/VeriSign-Class%203-Public-Primary-Certification-Authority-G5.pem">Symantec </a>.</p>
<p>docs: SDK API and file documentation.</p>
<p>mbedtls_lib: The mbedTLS source files. This directory is included when downloading the mbedTLS version of the SDK. It contains the mbedTLS source files to be built into the device application.</p>
<p>sample_apps: This directory contains sample applications as well as their makefiles. These makefiles include the relevant source files in the above two directories. The samples include a simple MQTT example which publishes and subscribes to the AWS IoT service as well as a device shadow example that shows example usage of the device shadow functionality.</p>
<h2><a class="anchor" id="integrate"></a>
Integrating the SDK into your environment</h2>
<p>This section explains the API calls that need to be implemented in order for the Device SDK to run on your platform. The SDK interfaces follow the driver model where only prototypes are defined by the Device SDK itself while the implementation is delegated to the user of the SDK to adjust it to the platform in use. The following sections list the needed functionality for the device SDK to run successfully on any given platform.</p>
<h3><a class="anchor" id="timer"></a>
Timer Functions</h3>
<p>A timer implementation is necessary to handle request timeouts (sending MQTT connect, subscribe, etc. commands) as well as connection maintenance (MQTT keep-alive pings). Timers need millisecond resolution and are polled for expiration so these can be implemented using a "milliseconds since startup" free-running counter if desired. In the synchronous sample provided with this SDK only one command will be "in flight" at one point in time plus the client's ping timer. <a class="el" href="timer__interface_8h.html" title="Timer interface definition for MQTT client.">timer_interface.h</a> Define the <a class="el" href="structTimer.html">Timer</a> Struct as in <a class="el" href="timer__linux_8h.html">timer_linux.h</a> <a class="el" href="timer_8c.html#a0ff0436566be2657b87044a108a1f4bf" title="Initialize a timer.">InitTimer()</a></p>
<p><a class="el" href="timer_8c.html#a9e1050bfa919aca1978cffb051cc7ee9" title="Check if a timer is expired.">expired()</a></p>
<p><a class="el" href="timer_8c.html#a75af8f6d4820a905276fae6bac80212a" title="Create a timer (milliseconds)">countdown_ms()</a></p>
<p><a class="el" href="timer_8c.html#ab9b6a721d03b085959a0f66907822629" title="Create a timer (seconds)">countdown()</a></p>
<p><a class="el" href="timer_8c.html#a9057a416766ddfe329756bc83cf969d0" title="Check the time remaining on a give timer.">left_ms()</a></p>
<h3><a class="anchor" id="network"></a>
Network Functions</h3>
<p>In order to for the MQTT client stack to be able to communicate via the TCP/IP network protocol stack using a mutually authenticated TLS connection, the following API calls need to be implemented for your platform. For additional details about API parameters refer to the API documentation. <a class="el" href="network__interface_8h.html" title="Network interface definition for MQTT client.">network_interface.h</a> <a class="el" href="network__interface_8h.html#ab17c9e7cec3c8d74bf338d18dd77fe83" title="Initialize the TLS implementation.">iot_tls_init()</a></p>
<p><a class="el" href="network__interface_8h.html#af3b017dbd1b7f3c84815dc6211c60284" title="Create a TLS socket and open the connection.">iot_tls_connect()</a></p>
<p><a class="el" href="network__interface_8h.html#affa29ed55e598ac01574f863ddceae66" title="Write bytes to the network socket.">iot_tls_write()</a></p>
<p><a class="el" href="network__interface_8h.html#a5ff537ba2223e211242e82e6582ab103" title="Read bytes from the network socket.">iot_tls_read()</a></p>
<p><a class="el" href="network__interface_8h.html#ad85769916d75a8bb778cdf2126dd4f02" title="Disconnect from network socket.">iot_tls_disconnect()</a></p>
<p><a class="el" href="network__interface_8h.html#a4d1624f588b2b18cd6d0d6974cb741d4" title="Perform any tear-down or cleanup of TLS layer.">iot_tls_destroy()</a></p>
<p>The TLS library generally provides the API for the underlying TCP socket.</p>
<h2><a class="anchor" id="Time"></a>
Time source for certificate validation</h2>
<p>As part of the TLS handshake the device (client) needs to validate the server certificate which includes validation of the certificate lifetime requiring that the device is aware of the actual time. Devices should be equipped with a real time clock or should be able to obtain the current time via NTP. Bypassing validation of the lifetime of a certificate is not recommended as it exposes the device to a security vulnerability, as it will still accept server certificates even when they have already expired.</p>
<h2><a class="anchor" id="IntegrationOS"></a>
Integration into operating system</h2>
<h3><a class="anchor" id="singleThreaded"></a>
Single-Threaded implementation</h3>
<p>The single threaded implementation implies that the sample application code (SDK + MQTT client) is called periodically by the firmware application running on the main thread. This is done by calling the function iot_mqtt_yield() (in the simple pub-sub example) and by calling iot_shadow_yield() (in the device shadow example). In both cases the keep-alive time is set to 10 seconds. This means that the yield functions need to be called at a minimum frequency of once every 10 seconds. Note however that the yield() function takes care of reading incoming MQTT messages from the IoT service as well and hence should be called more frequently depending on the timing requirements of an application. All incoming messages can only be processed at the frequency at which yield() is called.</p>
<h3><a class="anchor" id="mutliThreaded"></a>
Multi-Threaded implementation</h3>
<p>In the simple multithreaded case the yield() function can be moved to a background thread. Ensure this task runs at the frequency described above. In this case, depending on the OS mechanism, a message queue or mailbox could be used to proxy incoming MQTT messages from the callback to the worker task responsible for responding to or dispatching messages. A similar mechanism could be employed to queue publish messages from threads into a publish queue that are processed by a publishing task.</p>
<h2><a class="anchor" id="sampleapp"></a>
Sample applications</h2>
<p>The sample apps in this SDK provide a working implementation for either openSSL or mbedTLS, meaning that the function calls explained above are already implemented for these environments. </p>
<h3><a class="anchor" id="memoryreq"></a>
Memory Requirements</h3>
<p>Building the SDK shadow example using the Keil ARM toolchain on a Windows box.</p>
<p>Target is an ARM Cortex M4.</p>
<p>Code: ~8kb code+const</p>
<p>RAM: ~12kb</p>
<p>These numbers are with TLS and TCP/IP code stubbed out. This is just the SDK. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed Oct 21 2015 16:59:44 for AWSIoTEmbeddedCDeviceSDK by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
